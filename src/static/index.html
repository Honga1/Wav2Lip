<html>
  <head>
    <title>VS Code Rocks!</title>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
  </head>
  <body>
    <h1>Upload new File</h1>
    <form method="post" enctype="multipart/form-data">
      <label for="sound">Sound(wav)</label>
      <input type="file" name="sound" />
      <label for="image">Image(png)</label>
      <input id="image" type="file" name="image" />
      <input type="submit" />
    </form>


    <button id="record-audio" onclick="startRecording()">Record Audio</button>
    <button id="record-image" onclick="recordImage()">Record Image</button>
    <button id="record-image" onclick="submitRecorded()">Submit Recorded</button>

    <div id="image-holder">
      <img></img>
    </div>

    <video id="webcam" autoplay playsinline width="640" height="480"></video>

    <script>
      let recordedAudio = undefined;
      let recordedImage = undefined;
      const canvas = document.createElement('canvas');
      const webcam = new Webcam(document.getElementById("webcam"), 'user', canvas);

      async function sendData(url, data) {
        const formData  = new FormData();

        for(const name in data) {
          console.log(data);
          formData.append(name, data[name]);
        }

        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });

        // ...
      }

      function submitRecorded() {
        const formData = new FormData();
        formData.append("sound", recordedAudio, 'sound.wav');
        formData.append("image", recordedImage, 'face.png');

        const response = fetch('/image', {
          method: 'POST',
          body: formData
        });

        // sendData('/image', {sound: recordedAudio, image: recordedImage})
      }

      const webcamPromiseToStart = webcam.start();

      function recordImage() {
        const run = async () => {
        await webcamPromiseToStart;
        const photo = webcam.snap();
        var img = document.querySelector("img");
        img.src = photo;
        recordedImage = await new Promise((resolve) => canvas.toBlob(resolve));
        }
        run();
      }

      function dataURIToBlob(dataURI) {
        dataURI = dataURI.replace(/^data:/, '');

        const type = dataURI.match(/image\/[^;]+/);
        const base64 = dataURI.replace(/^[^,]+,/, '');
        const arrayBuffer = new ArrayBuffer(base64.length);
        const typedArray = new Uint8Array(arrayBuffer);

        for (let i = 0; i < base64.length; i++) {
            typedArray[i] = base64.charCodeAt(i);
        }

        return new Blob([arrayBuffer], {type});
      }

      window.addEventListener("load", function () {
        document
          .getElementById("image")
          .addEventListener("change", function () {
            if (this.files && this.files[0]) {
              var img = document.querySelector("img");
              img.src = URL.createObjectURL(this.files[0]);
            }
          });
      });

    const recordAudio = () =>
      new Promise(async resolve => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        const audioChunks = [];

        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });

        const start = () => mediaRecorder.start();

        const stop = () =>
          new Promise(resolve => {
            mediaRecorder.addEventListener("stop", () => {
              const audioBlob = new Blob(audioChunks);
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              const play = () => audio.play();
              resolve({ audioBlob, audioUrl, play });
            });

            mediaRecorder.stop();
          });

        resolve({ start, stop });
      });

    const sleep = time => new Promise(resolve => setTimeout(resolve, time));
    
    const startRecording = () => {
    (async () => {
      const recorder = await recordAudio();
      recorder.start();
      await sleep(10000);
      const audio = await recorder.stop();
      recordedAudio = audio.audioBlob;

      audio.play();
    })();
    }



    </script>
  </body>
</html>
